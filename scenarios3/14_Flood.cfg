#textdomain wesnoth-Rise_of_the_Elementalist

#define FLOOD_TERRAIN MATCH NEW_TERRAIN
    [store_locations]
        {MATCH}
        variable=tmp_locs
    [/store_locations]
    {FOREACH tmp_locs i}
        [terrain]
            x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
            terrain={NEW_TERRAIN}
        [/terrain]
    {NEXT i}
#enddef

#define CLEAR_RUBBLE
    [remove_unit_overlay]
        x,y=$x1,$y1
        image="misc/carry-rubble.png"
    [/remove_unit_overlay]
    {CLEAR_VARIABLE unit.variables.has_rock}
    [unstore_unit]
        variable=unit
    [/unstore_unit]
#enddef

[scenario]
    id="14_Flood"
    name= _ "Flood"
    map_data="{~add-ons/Rise_of_the_Elementalist/maps3/Flood.map}"
    turns=-1
    next_scenario=15_Assault
    victory_when_enemies_defeated=no
    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

    {SIDE_PLAYER 1 Allies (_ "Celestia") 250 0 (
        {CELESTIA_MACRO}
        save_id=Water
        recruit=Water Wave,Fog
    )}
    {SIDE_COMPUTER 2 Elementals (_ "Elementals") 250 20 (
        type=Earth Elemental
        canrecruit=yes
        recruit=Rock Pile,Earth Elemental,Fire Wisp,Fire Elemental,Minor Lava Elemental,Lava Elemental
        id=elemleader
    ) ()}
    {STARTING_VILLAGES_ALL 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Lava Elemental" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Minor Lava Elemental" 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Fire Elemental" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Fire Wisp" 2}

    {ON_PRESTART (
        [recall]
            id=Reana
        [/recall]

        [store_locations]
            terrain=Ww,Wwf
            variable=orig_water
        [/store_locations]
        {VARIABLE flood_y 30}

        [store_locations]
            x=22-26
            y=13-18
            [or]
                x,y=0,25
            [/or]
            variable=no_flood
        [/store_locations]

        [store_locations]
            x=8, 3, 22,18,13,22
            y=27,24,24,16,8, 1
            variable=rocks
        [/store_locations]

        {FOREACH rocks i}
            {PLACE_IMAGE "scenery/rubble.png" $rocks[$i].x $rocks[$i].y}
        {NEXT i}
        [store_locations]
            x=1, 8, 9, 22
            y=26,30,30,18
            variable=destinations
        [/store_locations]
        [store_locations]
            find_in=destinations
            [and]
                x,y=1,1
            [/and]
            variable=depth1_loc
        [/store_locations]
        [store_locations]
            find_in=depth1_loc
            variable=depth2_loc
        [/store_locations]

        {SET_OBJECTIVES 1 () (_"You may only recruit/recall on the first turn"+"
"+{NEW_GOLD_CARRYOVER_NOTE_40}) (
            {VICTORY_CONDITION (_ "Flood the cavern")}
            {CELESTIA_DEATH_OBJECTIVES}
            {REANA_DEATH_OBJECTIVES}
            {DEFEAT_CONDITION (_ "Death of the enemy leader")}
        )}
    )}

    {ON_START (
        {MSG id=Celestia (_ "Kil'rathacar is right below this cavern. We need to ensure that we do not let any elementals escape to the exits to raise an alarm")}
        {MSG id=Reana (_ "What is your plan?")}
        {MSG id=Celestia (_ "Below is deep cavern with magma deep below. If we were to attack now, he would have a distinct advantage. However, if we were to flood the cavern, I could use the water to freeze the ground and cool the magma. This would give us the upper hand and allow us to get to him past his armies")}
        {MSG id=Reana (_ "How do you propose we flood the cavern and be able to release it?")}
        {MSG id=Celestia (_ "If we use loose rocks, or the rocks from defeated earth elementals, we can dam up the exits and the river. Also we need to make sure that we do not kill the leader as we need to make sure we have enough of a rock supply")}
        {FOREACH destinations i}
            {GO_HERE $destinations[$i].x $destinations[$i].y ()}
        {NEXT i}

        #TODO: enemy message they want to raise alarm
    )}

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [not]
                type=Fog
            [/not]
            [not]
                [filter_wml]
                    [variables]
                        has_rock=yes
                    [/variables]
                [/filter_wml]
            [/not]
            [filter_location]
                find_in=rocks
            [/filter_location]
        [/filter]
        {REMOVE_IMAGE $x1 $y1}
        [unit_overlay]
            x,y=$x1,$y1
            image="misc/carry-rubble.png"
        [/unit_overlay]
        [store_locations]
            find_in=rocks
            [not]
                x,y=$x1,$y1
            [/not]
            variable=rocks
        [/store_locations]
        {DEBUG "Number of rock locations now: $rocks.length"}
        {VARIABLE unit.variables.has_rock yes}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                find_in=destinations
            [/filter_location]
            [filter_wml]
                [variables]
                    has_rock=yes
                [/variables]
            [/filter_wml]
        [/filter]

        [if]
            [have_location]
                x,y=$x1,$y1
                find_in=depth2_loc
            [/have_location]
            [then]
                {CLEAR_RUBBLE}
                [store_locations]
                    find_in=destinations
                    [not]
                        x,y=$x1,$y1
                    [/not]
                    variable=destinations
                [/store_locations]
                [store_locations]
                    find_in=depth2_loc
                    [not]
                        x,y=$x1,$y1
                    [/not]
                    variable=depth2_loc
                [/store_locations]
                {FIND_NEARBY (
                    [not]
                        terrain=Xu
                    [/not]
                    [not]
                        x,y=$x1,$y1
                    [/not]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                ) $x1 $y1 5}
                {DEBUG "Moving unit to $nearby_locations[0].x $nearby_locations[0].y"}
                {MOVE_UNIT id=$unit.id $nearby_locations[0].x $nearby_locations[0].y}
                {CLEANUP_SEARCH}
                {REMOVE_IMAGE $x1 $y1}
                [terrain]
                    x,y=$x1,$y1
                    terrain=Xu
                [/terrain]
                {REDRAW_MACRO}
                {MSG id=$unit.id (_ "This exit has been blocked")}
                {IF_VAR $destinations.length equals 0 (
                    [then]
                        {SET_OBJECTIVES 1 () ({NEW_GOLD_CARRYOVER_NOTE_40}) (
                            {VICTORY_CONDITION (_ "Wait for the cavern to flood")}
                            {VICTORY_CONDITION (_ "Or, kill the enemy leader")}
                            {CELESTIA_DEATH_OBJECTIVES}
                            {REANA_DEATH_OBJECTIVES}
                        )}
                    [/then]
                )}
            [/then]
            [else]
                [if]
                    [have_location]
                        x,y=$x1,$y1
                        find_in=depth1_loc
                    [/have_location]
                    [then]
                        {CLEAR_RUBBLE}
                        [store_locations]
                            find_in=depth2_loc
                            [or]
                                x,y=$x1,$y1
                            [/or]
                            variable=depth2_loc
                        [/store_locations]
                        [store_locations]
                            find_in=depth1_loc
                            [not]
                                x,y=$x1,$y1
                            [/not]
                            variable=depth1_loc
                        [/store_locations]
                        {REMOVE_IMAGE $x1 $y1}
                        {PLACE_IMAGE "items/gohere.png" $x1 $y1}
                        {PLACE_IMAGE "scenery/rubble_deep.png" $x1 $y1}
                    [/then]
                    [else]
                        {CLEAR_RUBBLE}
                        [store_locations]
                            find_in=depth1_loc
                            [or]
                                x,y=$x1,$y1
                            [/or]
                            variable=depth1_loc
                        [/store_locations]
                        {REMOVE_IMAGE $x1 $y1}
                        {PLACE_IMAGE "items/gohere.png" $x1 $y1}
                        {PLACE_IMAGE "scenery/rubble.png" $x1 $y1}
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    {ON_LAST_BREATH_MSG id=elemleader (_ "Me failed")}
    [event]
        name=die
        [filter]
            id=elemleader
        [/filter]
        {IF_VAR destinations.length equals 0 (
            [then]
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/then]
            [else]
                {MSG id=Celestia (_"No, we still need him alive!")}
                [endlevel]
                    result=defeat
                [/endlevel]
            [/else]
        )}
    [/event]

    [event]
        name=side 1 turn
        first_time_only=no
        [if]
            [have_location]
                x=8,9
                y=30,30
                terrain=Xu
                count=2
            [/have_location]
            [then]
                [if]
                    [have_location]
                        x,y=1,26
                        terrain=Xu
                    [/have_location]
                    [then]
                        [if]
                            [have_location]
                                x,y=22,18
                                terrain=Xu
                            [/have_location]
                            [then]
                                {CALL_FUNCTION flood min_y=-4}
                            [/then]
                            [else]
                                {CALL_FUNCTION flood min_y=25}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        {CALL_FUNCTION flood min_y=25}
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=flood
        first_time_only=no

        {DEBUG "Flood called. flood_y: $flood_y param.min_y: $param.min_y"}

        {IF_VAR flood_y greater_than $param.min_y (
            [then]
                {VARIABLE stage2 $flood_y} # Stage 2: convert shallow to water, hills to wet hills
                {VARIABLE stage3 $flood_y} # Stage 3: convert orig to deep, hills to water
                {VARIABLE_OP stage3 add 1}
                {VARIABLE stage4 $flood_y} # Stage 4: convert to deep
                {VARIABLE_OP stage4 add 3}
                {VARIABLE_OP flood_y add -1} # Flood y: convert to shallow

                {SCROLL_TO 12 $flood_y}
                {DEBUG "Flooding... flood_y: $flood_y stage 2: $stage2 stage3: $stage3, stage4: $stage4"}

                # Convert to shallow
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$flood_y
                    terrain=Uu
                ) Wyu}
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$flood_y
                    [not]
                        find_in=no_flood
                    [/not]
                    terrain=Ur
                ) Wyur}
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$flood_y
                    terrain=Uh
                ) Uyh}
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$flood_y
                    terrain=Uu^Vu
                ) Wyu^Vywu}
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$flood_y
                    terrain=Wwf
                ) Ww}

                # Convert shallow to water
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$stage2
                    terrain=Wyu,Wyur,Wyu^Vywu
                ) Ww}
                # Convert shallow hills to deeper hills
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$stage2
                    terrain=Uyh
                ) Wyuh}

                # Convert original water to deep water
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$stage3
                    find_in=orig_water
                    terrain=Ww
                ) Wo}
                # Convert submerged hills to water
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$stage3
                    terrain=Wyuh
                ) Ww}

                # Convert water to deep water
                {FLOOD_TERRAIN (
                    x=0-26
                    y=$stage4
                    terrain=Ww
                ) Wo}

                # Flood southern keep
                {IF_VAR flood_y equals 25 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=19-21
                            y=27
                            terrain=Ycud
                        ) Ycwu}
                        [terrain]
                            x,y=20,26
                            terrain=Ykwu
                        [/terrain]
                    [/then]
                )}
                # Drown southern keep
                {IF_VAR flood_y equals 23 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=19-21
                            y=27
                            terrain=Ycwu
                        ) Ww}
                        [terrain]
                            x,y=20,26
                            terrain=Ww
                        [/terrain]
                    [/then]
                )}
                # Make southern keep deep
                {IF_VAR flood_y equals 21 (
                    [then]
                        [terrain]
                            x=19-21
                            y=26-27
                            terrain=Wo
                        [/terrain]
                    [/then]
                )}

                # Flood our keep
                {IF_VAR flood_y equals 2 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=22-24
                            y=3-4
                            terrain=Ycud
                        ) Ycwu}
                        [terrain]
                            x,y=23,4
                            terrain=Ykwu
                        [/terrain]
                    [/then]
                )}
                # Drown our keep
                {IF_VAR flood_y equals 0 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=22-24
                            y=3-4
                            terrain=Ycwu
                        ) Ww}
                        [terrain]
                            x,y=23,4
                            terrain=Ww
                        [/terrain]
                    [/then]
                )}
                # Make our keep deep
                {IF_VAR flood_y equals -3 (
                    [then]
                        [terrain]
                            x=22-24
                            y=3-4
                            terrain=Wo
                        [/terrain]
                    [/then]
                )}
                # Flood their keep
                {IF_VAR flood_y equals 0 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=11-13
                            y=2-3
                            terrain=Ycud
                        ) Ycwu}
                        [terrain]
                            x,y=12,2
                            terrain=Ykwu
                        [/terrain]
                    [/then]
                )}
                # Drown their keep
                {IF_VAR flood_y equals -2 (
                    [then]
                        {FLOOD_TERRAIN (
                            x=11-13
                            y=2-3
                            terrain=Ycwu
                        ) Ww}
                        [terrain]
                            x,y=12,2
                            terrain=Ww
                        [/terrain]
                    [/then]
                )}
                # Make their keep deep
                {IF_VAR flood_y equals -4 (
                    [then]
                        [terrain]
                            x=11-13
                            y=2-3
                            terrain=Wo
                        [/terrain]
                    [/then]
                )}

                {CLEAR_VARIABLE stage2}
                {CLEAR_VARIABLE stage3}
                {CLEAR_VARIABLE stage4}
            [/then]
        )}
    [/event]

    [event]
        name=die
        [filter]
            type=Rock Pile,Earth Elemental
            [filter_location]
                [not]
                    find_in=rocks
                [/not]
            [/filter_location]
        [/filter]
        {PLACE_IMAGE "scenery/rubble.png" $x1 $y1}
        [store_locations]
            find_in=rocks
            [or]
                x,y=$x1,$y1
            [/or]
            variable=rocks
        [/store_locations]
    [/event]

    {ON_VICTORY (
        [store_unit]
            [filter]
                side=1
                [filter_wml]
                    [variables]
                        has_rock=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=tmp_units
        [/store_unit]
        {DEBUG "Need to remove overlay from $tmp_units.length units"}
        {FOREACH tmp_units i}
            {DEBUG "Cleaning up rock image from unit at $tmp_units[$i].x,$tmp_units[$i].y"}
            [remove_unit_overlay]
                x,y=$tmp_units[$i].x,$tmp_units[$i].y
                image="misc/carry-rubble.png"
            [/remove_unit_overlay]
            {CLEAR_VARIABLE tmp_units[$i].variables.has_rock}
            [unstore_unit]
                variable=tmp_units[$i]
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE tmp_units}
        {CLEAR_VARIABLE destinations}
        {CLEAR_VARIABLE rocks}
        {CLEAR_VARIABLE depth1_loc}
        {CLEAR_VARIABLE depth2_loc}
        {CLEAR_VARIABLE orig_water}
        {CLEAR_VARIABLE flood_y}
        {CLEAR_VARIABLE no_flood}
    )}

    #TODO: goto_x/y for enemy

    # Test events:
    [event]
        name=show debug options
        first_time_only=no
        [message]
            speaker=narrator
            message=_ "Select a debug option:"
            [option]
                message=_ "Jump to destination"
                [show_if]
                    [variable]
                        name=destinations.length
                        greater_than=0
                    [/variable]
                [/show_if]
                [command]
                    {SCROLL_TO $destinations[0].x $destinations[0].y}
                    {TELEPORT_UNIT id=Reana $destinations[0].x $destinations[0].y}
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            id=Reana
                        [/primary_unit]
                    [/fire_event]
                    {REDRAW_MACRO}
                [/command]
            [/option]
            [option]
                message=_ "Jump to rock"
                [show_if]
                    [variable]
                        name=rocks.length
                        greater_than=0
                    [/variable]
                [/show_if]
                [command]
                    {SCROLL_TO $rocks[0].x $rocks[0].y}
                    {TELEPORT_UNIT id=Reana $rocks[0].x $rocks[0].y}
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            id=Reana
                        [/primary_unit]
                    [/fire_event]
                    {REDRAW_MACRO}
                [/command]
            [/option]
            [option]
                message=_ "Complete dam"
                [show_if]
                    [variable]
                        name=destinations.length
                        greater_than=0
                    [/variable]
                [/show_if]
                [command]
                    {FOREACH destinations i}
                        [terrain]
                            x,y=$destinations[$i].x,$destinations[$i].y
                            terrain=Xu
                        [/terrain]
                        {REMOVE_IMAGE $destinations[$i].x $destinations[$i].y}
                    {NEXT i}
                    [store_locations]
                        find_in=destinations
                        x,y=1,1
                        variable=destinations
                    [/store_locations]
                    [store_locations]
                        find_in=destinations
                        variable=depth1_loc
                    [/store_locations]
                    [store_locations]
                        find_in=depth1_loc
                        variable=depth2_loc
                    [/store_locations]
                [/command]
            [/option]
            [option]
                message=_ "Test flood"
                [show_if]
                    [variable]
                        name=destinations.length
                        equals=0
                    [/variable]
                    [variable]
                        name=flood_y
                        greater_than=0
                    [/variable]
                [/show_if]
                [command]
                    {CALL_FUNCTION flood min_y=-4}
                [/command]
            [/option]
            [option]
                message=_ "Test flood completely"
                [show_if]
                    [variable]
                        name=destinations.length
                        equals=0
                    [/variable]
                    [variable]
                        name=flood_y
                        greater_than=0
                    [/variable]
                [/show_if]
                [command]
                    [while]
                        [variable]
                            name=flood_y
                            greater_than=-4
                        [/variable]
                        [do]
                            {CALL_FUNCTION flood min_y=-4}
                            [delay]
                                time=500
                            [/delay]
                        [/do]
                    [/while]
                [/command]
            [/option]
            [option]
                message=_ "Kill enemy leader"
                [command]
                    [kill]
                        id=elemleader
                        fire_event=yes
                    [/kill]
                [/command]
            [/option]
        [/message]
    [/event]
[/scenario]
