#textdomain wesnoth-Rise_of_the_Elementalist

[scenario]
    id="02_Reawakening"
    name= _ "Reawakening"
    map_data="{~add-ons/Rise_of_the_Elementalist/maps2/DwarvenExploration.map}"
    turns=-1
    next_scenario=03_Fusion
    victory_when_enemies_defeated=no
    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

    [story]
        [part]
            story=_ "You awake as if from a deep slumber. You are confused and your mind is divided. It is almost as if you can feel yourself in multiple places.

The confusion is making you mad. You are angry, but do not know why. One thing you do know is that you are weak. You need to build back up your strength, and you do remember that you do that by destroying your foes."
        [/part]
        [part]
            story=_ "You follow the lava flow, not knowing where it leads..."
            background=portraits/transparent/fire-wisp.png
        [/part]
    [/story]

    [side]
        side=1
        id=fireleader
        type=Fire Wisp
        team_name=demon
        user_team_name=_ "You"
        gold=0
        controller=human
        shroud=yes
        fog=yes
        x,y=6,3
        canrecruit=yes
        save_id=lotd
        [modifications]
            {TRAIT_DEXTROUS}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    {SIDE_COMPUTER 2 "Dwarves" (_ "Smelting Dwarves") 0 0 (
        type=Dwarvish Steelclad
        random_traits=yes
        canrecruit=yes
        {GENERIC_UNIT 2 "Dwarvish Fighter" 9 18}
        [+unit]
            ai_special=guardian
        [/unit]

        {GENERIC_UNIT 2 "Dwarvish Fighter" 11 17}
        [+unit]
            ai_special=guardian
        [/unit]

        {GENERIC_UNIT 2 "Dwarvish Fighter" 18 11}
        {GENERIC_UNIT 2 "Dwarvish Guardsman" 18 13}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 2 1 1 25}
    {SIDE_COMPUTER 3 "Dwarves" (_ "Mining Dwarves") 0 0 (
        type=Dwarvish Thunderguard
        canrecruit=yes
        random_traits=yes
        {GENERIC_UNIT 3 "Dwarvish Fighter" 19 47}
        {GENERIC_UNIT 3 "Dwarvish Thunderer" 23 32}
        {GENERIC_UNIT 3 "Dwarvish Thunderer" 8 45}
        {GENERIC_UNIT 3 "Dwarvish Fighter" 6 47}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 3 1 50 15}
    {SIDE_COMPUTER 4 "Dwarves" (_ "Bridge Builders") 0 0 (
        type=Dwarvish Pathfinder
        random_traits=yes
        canrecruit=yes
        {GENERIC_UNIT 4 "Dwarvish Fighter" 38 29}
        {GENERIC_UNIT 4 "Dwarvish Fighter" 40 28}
        {GENERIC_UNIT 4 "Dwarvish Fighter" 30 36}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 4 32 33 7}

    [event]
        name=prestart

        {VARIABLE kill_leader_objectives no}
        {VARIABLE fire_advancement_counter 0}

        {SET_OBJECTIVES 1 (_ "Regain your strength") ({NEW_GOLD_CARRYOVER_NOTE_40}) (
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "Explore")}
            ) kill_leader_objectives equals no}
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "Defeat the enemy leaders")}
            ) kill_leader_objectives equals yes}
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "You must reach level 2")}
            ) kill_leader_objectives equals yes}
            {CONDITIONAL_OBJECTIVE (
                {DEFEAT_CONDITION (_ "You die")}
            ) kill_leader_objectives equals yes}
        )}
    [/event]

    [event]
        name=start
    [/event]

    [event]
        name=sighted
        [filter]
            side=2
        [/filter]
        [filter_second]
            id=fireleader
        [/filter_second]
        {VARIABLE kill_leader_objectives yes}
        {MSG (id=fireleader) (_ "Small creatures... what are they called? Oh yes, dwarves. I hate dwarves!")}
        {NARRATOR (_ "You do not remember why you hate the dwarves so much, but the hatred is intense.

You hear the sounds smelting of weapons and armor to the east and drunken banter to the south.")}
        [show_objectives]
            side=1
        [/show_objectives]

        [modify_side]
            side=2
            switch_ai=ai/ais/default_ai.cfg
        [/modify_side]
        [modify_side]
            side=2
            [ai]
                aggression=2.0
                caution=0.1
            [/ai]
        [/modify_side]

        [allow_recruit]
            side=2
            type=Dwarvish Fighter,Dwarvish Guardsman
        [/allow_recruit]
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Hey, did you hear something?")}
        {MSG (
            side=2
            x,y=18,13
        ) (_ "What did it sound like?")}
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Like a fire burning.")}
        {MSG (
            side=2
            x,y=18,13
        ) (_ "You idiot, you are working in a forge, what do you expect to hear?")}
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Oh nevermind.")}
    [/event]

    {ON_ATTACK_MESSAGE fire_attack_msg (
        id=fireleader
    ) (
        side=2
    ) (
        {MSG (id=$unit2_id) (_ "What on Irdya is this thing, has the lava come to life?!
Get this thing off of my back!")}
        {MSG (
            side=2
            [not]
                id=$unit2_id
            [/not]
        ) (_ "Hold on, I'm coming!")}
    )}

    {ON_ATTACK_MESSAGE rock_attack_msg (
        id=rockleader
    ) (
        side=3
    ) (
        {MSG (id=$unit2_id) (_ "Hey, these boulders are moving, I think it is some kind of golem.")}
        {MSG (
            side=3
            type=Dwarvish Thunderguard
        ) (_ "What? I'll send some backup your way just in case.")}
    )}

    [event]
        name=post advance
        [filter]
            id=fireleader
        [/filter]
        {MSG (id=fireleader) (_ "Ah, my strength is returning, but I am not whole. I must find a way to reunite myself.")}
        {NARRATOR (_ "As your power grows, you begin to remember that the dwarves are partly responsible for you captivity.

A thought also begins to form in your mind about a potential way to unite the separate parts of yourself back together.")}

        [fire_event]
            name=check fire victory
        [/fire_event]
    [/event]

    [event]
        name=post advance
        first_time_only=no
        [filter]
            id=fireleader
        [/filter]
        {VARIABLE_OP fire_advancement_counter add 1}
        [if]
            [have_unit]
                side=1
                count=1-4
            [/have_unit]
            [then]
                {MSG (id=fireleader) (_ "Ah, I can feel my magic power growing. Rise creature of the flame!")}
                {FIND_NEARBY (
                    terrain=Qlf,Ql
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                ) $unit.x $unit.y 10}
                {SCROLL_TO $nearby_locations[0].x $nearby_locations[0].y}
                {GENERIC_UNIT 1 ("Fire Wisp") $nearby_locations[0].x $nearby_locations[0].y}
                [+unit]
                    animate=yes
                [/unit]
                {REDRAW_MACRO}
                {MSG (
                    x,y=$nearby_locations[0].x,$nearby_locations[0].y
                ) (_ "I live to serve.")}
                {CLEANUP_SEARCH}
            [/then]
        [/if]
        [if]
            [variable]
                name=fire_advancement_counter
                equals=2
            [/variable]
            [then]
                {MSG (id=fireleader) (_ "I can feel the lava, I can control it! Let their roads burn!")}
                [terrain]
                    x,y=14,7
                    terrain=Ql
                [/terrain]
                {VARIABLE tmp_y 8}
                [store_locations]
                    terrain=Ur
                    variable=tmp_locs
                [/store_locations]
                {DEBUG "Num roads: $tmp_locs.length"}
                {VARIABLE show_kill_message yes}
                [while]
                    [variable]
                        name=tmp_y
                        less_than=20
                    [/variable]
                    [do]
                        {DEBUG "y: $tmp_y"}
                        {FOREACH tmp_locs i}
                            {IF_VAR tmp_y equals $tmp_locs[$i].y (
                                [then]
                                    {DEBUG "x,y: $tmp_locs[$i].x,$tmp_locs[$i].y"}
                                    [terrain]
                                        x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        terrain=Qlf
                                    [/terrain]
                                    {REDRAW_MACRO}
                                    [if]
                                        [have_unit]
                                            [not]
                                                side=1
                                            [/not]
                                            x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        [/have_unit]
                                        [variable]
                                            name=show_kill_message
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE show_kill_message no}
                                            {MSG (
                                                x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                            ) (_ "Arrrrghhh, the roads are melting!")}
                                        [/then]
                                    [/if]
                                    [kill]
                                        [not]
                                            side=1
                                        [/not]
                                        x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        fire_event=yes
                                        animate=yes
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}
                        [delay]
                            time=250
                        [/delay]
                        {VARIABLE_OP tmp_y add 1}
                    [/do]
                [/while]
                {IF_VAR show_kill_message equals yes (
                    [then]
                        {VARIABLE show_kill_message no}
                        {MSG (
                            side=2
                        ) (_ "The roads have melted!")}
                    [/then]
                )}
                {CLEAR_VARIABLE tmp_locs}
                {CLEAR_VARIABLE tmp_y}
                {CLEAR_VARIABLE show_kill_message}
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            side=2
            canrecruit=yes
        [/filter]
        {DEBUG "Die event fired for side 2 leader"}
        [kill]
            id=$unit.id
            fire_event=no
        [/kill]
        [fire_event]
            name=check fire victory
        [/fire_event]
    [/event]
    [event]
        name=check fire victory
        first_time_only=no
        {STORE_UNIT_VAR (id=fireleader) level fire_level}
        {DEBUG "Checking for fire victory. Level: $fire_level"}
        [if]
            [variable]
                name=fire_level
                equals=2
            [/variable]
            [have_unit]
                side=2
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                [unit]
                    side=1
                    id=rockleader
                    type=Rock Pile
                    x,y=1,47
                    canrecruit=yes
                    {IS_HERO}
                    [modifications]
                        {TRAIT_RESILIENT}
                        {TRAIT_STRONG}
                    [/modifications]
                [/unit]
                [store_unit]
                    [filter]
                        id=fireleader
                    [/filter]
                    variable=fireleader
                    kill=yes
                    fire_event=no
                [/store_unit]
                [store_unit]
                    [filter]
                        side=1
                        [not]
                            id=rockleader
                        [/not]
                    [/filter]
                    variable=fire_units
                    kill=yes
                    fire_event=no
                [/store_unit]
                {REDRAW_MACRO}
                [kill]
                    side=2
                    fire_event=no
                    animate=no
                [/kill]
                {NARRATOR (_ "Meanwhile...")}
                {SCROLL_TO 1 47}
                {MSG (id=rockleader) (_ "I hear hammers hitting wall.")}
                {MOVE_UNIT id=rockleader 4 47}
                {MSG (id=rockleader) (_ "Wall is thin, see who invades caves...")}
                {REPEAT 4 (
                    [animate_unit]
                        flag=attack
                        [filter]
                            id=rockleader
                        [/filter]
                        [primary_attack]
                            range=melee
                        [/primary_attack]
                        hits=yes
                        [facing]
                            x,y=5,47
                        [/facing]
                    [/animate_unit]
                    {QUAKE "rumble.ogg"}
                )}
                {MODIFY_TERRAIN Uh (5) (47-48)}
                {REDRAW_MACRO}
                [modify_side]
                    side=3
                    switch_ai=ai/ais/default_ai.cfg
                [/modify_side]
                [modify_side]
                    side=3
                    [ai]
                        leader_aggression=0.0
                    [/ai]
                [/modify_side]
                [allow_recruit]
                    side=3
                    type=Dwarvish Fighter,Dwarvish Thunderer
                [/allow_recruit]

                {MSG (
                    x,y=8,45
                ) (_ "What is going on, are you using powder to blast those walls?!")}
                {MSG (
                    x,y=6,47
                ) (_ "No the wall just shuck violently and came crashing down. I don't see anything though except for a bunch of boulders. I'll have a look.")}

                # Reminder:
                [show_objectives]
                    side=1
                [/show_objectives]
            [/then]
        [/if]
        {CLEAR_VARIABLE fire_level}
    [/event]

    [event]
        name=post advance
        first_time_only=no
        [filter]
            id=rockleader
        [/filter]
        {MSG (id=rockleader) (_ "Rise my rocks and kill the invaders!")}
        {FIND_NEARBY (
            terrain=Uh
            [not]
                [filter]
                [/filter]
            [/not]
            [not]
                # Do not trap the new unit behind the leader
                x,y=6,49
            [/not]
        ) $x1 $y1 10}
        {GENERIC_UNIT 1 "Rock Pile" $nearby_locations[0].x $nearby_locations[0].y}
        [+unit]
            animate=yes
        [/unit]
        {CLEANUP_SEARCH}
    [/event]

    [event]
        name=post advance
        [filter]
            id=rockleader
        [/filter]
        {MSG (id=rockleader) (_ "Much stronger now, head starting to clear. Hmmmm, lets see what I can do with that dwarven encampment...")}

        [remove_shroud]
            side=1
            x=8-12
            y=41-45
        [/remove_shroud]
        {SCROLL_TO 10 42}
        {QUAKE "rumble.ogg"}
        {MODIFY_TERRAIN Uu^Dr (9,10-11) (42-43,42)}
        {REDRAW_MACRO}
        {MSG (
            side=3
            canrecruit=yes
        ) (_ "Our keep has been destroyed!")}
        [fire_event]
            name=check rock victory
        [/fire_event]
    [/event]

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        {DEBUG "Side 3 leader died"}
        [kill]
            id=$unit.id
            fire_event=no
        [/kill]
        [fire_event]
            name=check rock victory
        [/fire_event]
    [/event]

    [event]
        name=check rock victory
        first_time_only=no
        {STORE_UNIT_VAR (id=rockleader) level rock_level}
        {DEBUG "Checking rock victory. Level: $rock_level"}
        [if]
            [variable]
                name=rock_level
                greater_than_equal_to=2
            [/variable]
            [have_unit]
                side=3
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                [unit]
                    side=1
                    id=airleader
                    type=Whirlwind
                    x,y=50,50
                    canrecruit=yes
                    {IS_HERO}
                    [modifications]
                        {TRAIT_STRONG}
                        {TRAIT_RESILIENT}
                    [/modifications]
                [/unit]
                [store_unit]
                    [filter]
                        id=rockleader
                    [/filter]
                    variable=rockleader
                    kill=yes
                    fire_event=no
                [/store_unit]
                [store_unit]
                    [filter]
                        side=1
                        [not]
                            id=airleader
                        [/not]
                    [/filter]
                    variable=rock_units
                    kill=yes
                    fire_event=no
                [/store_unit]
                {REDRAW_MACRO}
                [kill]
                    side=3
                    fire_event=no
                    animate=no
                [/kill]
                {NARRATOR (_ "During this time, the whirlwind was investigating the open cavernous areas...")}
                {SCROLL_TO 50 50}
                {MSG (id=airleader) (_ "More open caves. I must build my strength. Wait... I hear the sound of tools being used on rocks echoing in these caverns. I must find the source.")}
                [modify_side]
                    side=4
                    switch_ai=ai/ais/default_ai.cfg
                [/modify_side]
                [allow_recruit]
                    side=4
                    type=Dwarvish Fighter
                [/allow_recruit]
                [modify_side]
                    side=4
                    [ai]
                        aggression=1.0
                        [protect_location]
                            x,y=40,28
                            radius=0
                            value=2
                        [/protect_location]
                        [protect_location]
                            x,y=38,29
                            radius=0
                            value=2
                        [/protect_location]
                    [/ai]
                [/modify_side]

                {VARIABLE kill_leader_objectives no}
                [show_objectives]
                    side=1
                [/show_objectives]

                {VARIABLE air_advancement_count 0}
            [/then]
        [/if]
        {CLEAR_VARIABLE rock_level}
    [/event]

    [event]
        name=sighted
        [filter]
            side=4
        [/filter]
        [filter_second]
            id=airleader
        [/filter_second]
        {MSG (
            side=4
            [not]
                canrecruit=yes
            [/not]
        ) (_ "Hey, is it getting windy or what?")}
        {MSG (
            side=4
            canrecruit=yes
        ) (_ "Cut the chatter and get back to building that bridge!")}
    [/event]

    {ON_ATTACK_MESSAGE air_attack_msg (
        id=airleader
    ) (
        side=4
    ) (
        {MSG (id=$unit2_id) (_ "This wind is no ordinary force of nature. I think it is some kind of monster. To arms!")}

        {VARIABLE kill_leader_objectives yes}
        [show_objectives]
            side=1
        [/show_objectives]

        {VARIABLE bridge_complete_on $turn_number}
        {VARIABLE_OP bridge_complete_on add 4}
        {VARIABLE bridge_message_on $turn_number}
        {VARIABLE_OP bridge_message_on add 2}
    )}

    [event]
        name=side 4 turn
        first_time_only=no

        [if]
            [have_unit]
                side=4
                x,y=40,28
            [/have_unit]
            [or]
                [have_unit]
                    side=4
                    x,y=38,29
                [/have_unit]
            [/or]
            [then]
                {IF_VAR bridge_message_on equals $turn_number (
                    [then]
                        {MSG (
                            side=4
                            [and]
                                x,y=40,28
                                [or]
                                    x,y=38,29
                                [/or]
                            [/and]
                        ) (_ "The bridge is almost done!")}
                    [/then]
                    [else]
                        {IF_VAR bridge_complete_on equals $turn_number (
                            [then]
                                [terrain]
                                    x,y=39,29
                                    terrain="Qxu^Bs/"
                                [/terrain]
                                {MSG (
                                    side=4
                                    [and]
                                        x,y=40,28
                                        [or]
                                            x,y=38,29
                                        [/or]
                                    [/and]
                                ) (_ "The bridge is done!")}
                                [modify_side]
                                    side=4
                                    [ai]
                                        aggression=1.0
                                    [/ai]
                                [/modify_side]
                            [/then]
                        )}
                    [/else]
                )}
            [/then]
        [/if]
    [/event]

    [event]
        name=post advance
        first_time_only=no
        [filter]
            id=airleader
        [/filter]
        {MSG (id=airleader) (_ "Ah, my strength is returning. Now to whip up the air in here a bit...")}

        {VARIABLE_OP air_advancement_count add 1}
        {FIND_NEARBY (
            terrain=Qxu,Re,Ds
            [not]
                [filter]
                [/filter]
            [/not]
        ) $x1 $y1 15}
        {DEBUG "Creating Whirlwind at $nearby_locations[0].x,$nearby_locations[0].y"}
        {GENERIC_UNIT 1 Whirlwind $nearby_locations[0].x $nearby_locations[0].y}
        [+unit]
            animate=yes
        [/unit]
        {CLEANUP_SEARCH}

        {VARIABLE first_unit_match yes}
        [store_locations]
            terrain=Uu^Vu,Uu,Ur,Ds,Cud,Kud,Qxu^Bs/
            [and]
                x,y=$x1,$y1
                radius=10
            [/and]
            variable=tmp_locs
        [/store_locations]
        {DEBUG "Found $tmp_locs.length locations"}
        {FOREACH tmp_locs i}
            {DEBUG "x,y: $tmp_locs[$i].x,$tmp_locs[$i].y"}
            # Convert to sand:
            [if]
                [variable]
                    name=air_advancement_count
                    equals=1
                [/variable]
                [have_location]
                    x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                    terrain=Uu,Ur
                [/have_location]
                [then]
                    [terrain]
                        terrain=Ds
                        x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                    [/terrain]
                    {REDRAW_MACRO}
                [/then]
            [/if]

            [if]
                [have_unit]
                    side=4
                    x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                            side=4
                        [/filter]
                        variable=tmp_unit
                    [/store_unit]
                    {IF_VAR first_unit_match equals yes (
                        [then]
                            {MSG (
                                x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                            ) (_ "I can hardly breathe!")}
                            {VARIABLE first_unit_match no}
                        [/then]
                    )}
                    {VARIABLE tmp_hp $tmp_unit.hitpoints}
                    {DEBUG "tmp_hp: $tmp_hp"}
                    {VARIABLE_OP tmp_unit.hitpoints sub 5}
                    [if]
                        [variable]
                            name=tmp_unit.hitpoints
                            less_than_equal_to=0
                        [/variable]
                        [then]
                            {VARIABLE tmp_unit.hitpoints 1}
                        [/then]
                    [/if]
                    {VARIABLE_OP tmp_hp sub $tmp_unit.hitpoints}
                    {DEBUG "tmp_unit.hitpoints: $tmp_unit.hitpoints, tmp_hp: $tmp_hp"}
                    {IF_VAR tmp_hp greater_than 0 (
                        [then]
                            [unstore_unit]
                                variable=tmp_unit
                                text=$tmp_hp
                                {COLOR_HARM}
                            [/unstore_unit]
                        [/then]
                    )}
                    {CLEAR_VARIABLE tmp_unit}
                    {CLEAR_VARIABLE tmp_hp}
                [/then]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE first_unit_match}
        {CLEAR_VARIABLE tmp_locs}

        [fire_event]
            name=check air victory
        [/fire_event]
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [kill]
            id=$unit.id
            fire_event=no
        [/kill]
        [fire_event]
            name=check air victory
        [/fire_event]
    [/event]

    [event]
        name=check air victory
        first_time_only=no
        {STORE_UNIT_VAR (id=airleader) level air_level}
        [if]
            [variable]
                name=air_level
                greater_than_equal_to=2
            [/variable]
            [have_unit]
                side=4
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                {MSG (id=airleader) (_ "I can feel the others, they are near!")}
                {MOVE_UNIT (id=airleader) 35 26}
                {MSG (id=airleader) (_ "There is a crack here in the wall, I think I can fit through...")}
                {TELEPORT_UNIT (id=airleader) 33 26}
                {REDRAW_MACRO}
                [delay]
                    time=500
                [/delay]
                {FOREACH fire_units i}
                    [unstore_unit]
                        x,y=15,22
                        find_vacant=yes
                        variable=fire_units[$i]
                    [/unstore_unit]
                {NEXT i}
                {CLEAR_VARIABLE fire_units}
                [unstore_unit]
                    variable=fireleader
                    x,y=16,22
                [/unstore_unit]
                {CLEAR_VARIABLE fireleader}
                {REDRAW_MACRO}
                {SCROLL_TO 16 22}
                {MSG (id=fireleader) (_ "I can feel the others. I may be able to melt this wall...")}
                {FLASH_RED (
                    {MODIFY_TERRAIN Qlf (16-17) (23)}
                )}
                {MOVE_UNIT id=fireleader 17 24}
                {REDRAW_MACRO}
                [delay]
                    time=500
                [/delay]
                [unstore_unit]
                    variable=rockleader
                    x,y=23,32
                [/unstore_unit]
                {CLEAR_VARIABLE rockleader}
                {FOREACH rock_units i}
                    [unstore_unit]
                        x,y=18,32
                        find_vacant=yes
                        variable=rock_units[$i]
                    [/unstore_unit]
                {NEXT i}
                {CLEAR_VARIABLE rock_units}
                {REDRAW_MACRO}
                {SCROLL_TO 23 32}
                {MSG (id=rockleader) (_ "The others call...")}
                {REPEAT 2 (
                    [animate_unit]
                        flag=attack
                        [filter]
                            id=rockleader
                        [/filter]
                        [primary_attack]
                            range=melee
                        [/primary_attack]
                        hits=yes
                        [facing]
                            x,y=23,31
                        [/facing]
                    [/animate_unit]
                    {QUAKE "rumble.ogg"}
                )}
                [terrain]
                    x,y=23,31
                    terrain=Uu
                [/terrain]
                {MOVE_UNIT (id=rockleader) 23 30}
                {REDRAW_MACRO}

                {MSG (id=fireleader) (_ "We are all here, excellent. Do you remember where we created the elementals?")}
                {MSG (id=airleader) (_ "I remember.")}
                {MSG (id=rockleader) (_ "Me remembers.")}

                {MSG (id=fireleader) (_ "We must find it, I believe we can reverse the magic and heal ourself.

Air, go scout for more dwarves, rock, we will need your strength to smash through the cave walls, and I will lead us, I can feel the dais calling to us.")}

                {CLEAR_VARIABLE air_level}
                {CLEAR_VARIABLE air_advancement_count}
                {CLEAR_VARIABLE bridge_complete_on}
                {CLEAR_VARIABLE bridge_message_on}

                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/then]
        [/if]
        {CLEAR_VARIABLE air_level}
    [/event]

    [event]
        name=last breath
        [filter]
            side=2
            canrecruit=yes
        [/filter]
        {MSG (id=$unit.id) (_ "No, I must protect the forge...")}
    [/event]
    [event]
        name=last breath
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        {MSG (id=$unit.id) (_ "Someone must warn the...")}
    [/event]
    [event]
        name=last breath
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        {MSG (id=$unit.id) (_ "Arggghhh")}
    [/event]

    # Test events:
    [event]
        name=killenemy
        first_time_only=no
        {STORE_UNIT_VAR (
            side=1
            canrecruit=yes
        ) id leader_id}
        [switch]
            variable=leader_id
            [case]
                value=fireleader
                {VARIABLE kill_side 2}
            [/case]
            [case]
                value=rockleader
                {VARIABLE kill_side 3}
            [/case]
            [case]
                value=airleader
                {VARIABLE kill_side 4}
            [/case]
        [/switch]
        {CLEAR_VARIABLE leader_id}
        [kill]
            side=$kill_side
            canrecruit=yes
            fire_event=yes
        [/kill]
        {CLEAR_VARIABLE kill_side}
    [/event]
    [event]
        name=show debug options
        first_time_only=no
        [message]
            speaker=narrator
            message=_ "Select a debug option:"
            [option]
                message= _"Advance leader"
                [command]
                    {ADVANCE_UNIT canrecruit,side=yes,1 ""}
                [/command]
            [/option]
            [option]
                message=_ "Kill enemy leader"
                [command]
                    [fire_event]
                        name=killenemy
                    [/fire_event]
                [/command]
            [/option]
            [option]
                message=_ "Jump to rock"
                [show_if]
                    [have_unit]
                        side=1
                        id=fireleader
                    [/have_unit]
                [/show_if]
                [command]
                    {ADVANCE_UNIT canrecruit,side=yes,1 ""}
                    [fire_event]
                        name=killenemy
                    [/fire_event]
                [/command]
            [/option]
            [option]
                message=_ "Jump to air"
                [show_if]
                    [have_unit]
                        side=1
                        id=fireleader
                    [/have_unit]
                [/show_if]
                [command]
                    {ADVANCE_UNIT canrecruit,side=yes,1 ""}
                    [fire_event]
                        name=killenemy
                    [/fire_event]
                    {ADVANCE_UNIT canrecruit,side=yes,1 ""}
                    [fire_event]
                        name=killenemy
                    [/fire_event]
                [/command]
            [/option]
            [option]
                message=_ "Jump to air"
                [show_if]
                    [have_unit]
                        side=1
                        id=rockleader
                    [/have_unit]
                [/show_if]
                [command]
                    {ADVANCE_UNIT canrecruit,side=yes,1 ""}
                    [fire_event]
                        name=killenemy
                    [/fire_event]
                [/command]
            [/option]
            [option]
                message=_ "Cancel"
                [command][/command]
            [/option]
        [/message]
    [/event]

    {MAIN_DEATHS}
[/scenario]
