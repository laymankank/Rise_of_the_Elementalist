#textdomain wesnoth-Rise_of_the_Elementalist

[scenario]
    id="02_Reawakening"
    name= _ "Reawakening"
    map_data="{~add-ons/Rise_of_the_Elementalist/maps2/DwarvenExploration.map}"
    turns=-1
    next_scenario=03_Fusion
    victory_when_enemies_defeated=no
    {UNDERGROUND}

    [story]
        [part]
            story=_ "You awake as if from a deep slumber. You are confused and your mind is divided. It is almost as if you can feel yourself in multiple places.

The confusion is making you mad. You are angry, but do not know why. One thing you do know is that you are weak. You need to build back up your strength, and you do remember that you do that by destroying your foes."
        [/part]
        [part]
            story=_ "You follow the lava flow, not knowing where it leads..."
            background=portraits/transparent/fire-wisp.png
        [/part]
    [/story]

    [side]
        side=1
        id=fireleader
        type=Fire Wisp
        team_name=demon
        user_team_name=_ "You"
        gold=0
        controller=human
        shroud=yes
        fog=yes
        x,y=6,3
        canrecruit=yes
        [modifications]
            {TRAIT_DEXTROUS}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    {SIDE_COMPUTER 2 "Dwarves" (_ "Smelting Dwarves") 0 0 (
        type=Dwarvish Steelclad
        random_traits=yes
        canrecruit=yes
        {GENERIC_UNIT 2 "Dwarvish Fighter" 9 18}
        [+unit]
            ai_special=guardian
        [/unit]

        {GENERIC_UNIT 2 "Dwarvish Fighter" 11 17}
        [+unit]
            ai_special=guardian
        [/unit]

        {GENERIC_UNIT 2 "Dwarvish Fighter" 18 11}
        {GENERIC_UNIT 2 "Dwarvish Guardsman" 18 13}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 2 1 1 25}
    {SIDE_COMPUTER 3 "Dwarves" (_ "Mining Dwarves") 0 0 (
        type=Dwarvish Thunderguard
        canrecruit=yes
        random_traits=yes
        {GENERIC_UNIT 3 "Dwarvish Fighter" 19 47}
        {GENERIC_UNIT 3 "Dwarvish Thunderer" 23 32}
        {GENERIC_UNIT 3 "Dwarvish Thunderer" 8 45}
        {GENERIC_UNIT 3 "Dwarvish Fighter" 6 47}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 3 1 50 15}
    {SIDE_COMPUTER 4 "Dwarves" (_ "Bridge Builders") 0 0 (
        type=Dwarvish Pathfinder
        random_traits=yes
        canrecruit=yes
        {GENERIC_UNIT 4 "Dwarvish Scout" 38 29}
        {GENERIC_UNIT 4 "Dwarvish Fighter" 40 28}
        {GENERIC_UNIT 4 "Dwarvish Fighter" 30 36}
    ) (
        ai_algorithm=idle_ai
    )}
    {STARTING_VILLAGES_AREA 4 32 33 7}

    [event]
        name=prestart

        {VARIABLE kill_leader_objectives no}
        {VARIABLE turns_limited no}
        {VARIABLE fire_advancement_counter 0}

        {SET_OBJECTIVES 1 (_ "Regain your strength") ({EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}) (
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "Explore")}
            ) kill_leader_objectives equals no}
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "Defeat the enemy leaders")}
            ) kill_leader_objectives equals yes}
            {CONDITIONAL_OBJECTIVE (
                {VICTORY_CONDITION (_ "You must reach level 2")}
            ) kill_leader_objectives equals yes}
            {CONDITIONAL_OBJECTIVE (
                {DEFEAT_CONDITION (_ "You die")}
            ) kill_leader_objectives equals yes}
            {CONDITIONAL_OBJECTIVE (
                {DEFEAT_CONDITION (_ "Turns run out")}
            ) turns_limited equals yes}
        )}
    [/event]

    [event]
        name=start
    [/event]

    [event]
        name=sighted
        [filter]
            side=2
        [/filter]
        [filter_second]
            id=fireleader
        [/filter_second]
        {VARIABLE kill_leader_objectives yes}
        {ID_MESSAGE fireleader (_ "Small creatures... what are they called? Oh yes, dwarves. I hate dwarves!")}
        {NARRATOR (_ "You do not remember why you hate the dwarves so much, but the hatred is intense.

You hear the sounds smelting of weapons and armor to the east and drunken banter to the south.")}
        {VARIABLE turn_no $turn_number}
        {VARIABLE_OP turn_no add 42}
        # Don't add to the turns as there is no turn limit at this point
        [modify_turns]
            value=$turn_no
        [/modify_turns]
        {VARIABLE turns_limited yes}
        {CLEAR_VARIABLE turn_no}
        [show_objectives]
            side=1
        [/show_objectives]

        [modify_side]
            side=2
            switch_ai=ai/ais/default_ai.cfg
        [/modify_side]
        [modify_side]
            side=2
            [ai]
                aggression=2.0
                caution=0.1
            [/ai]
        [/modify_side]

        [allow_recruit]
            side=2
            type=Dwarvish Fighter,Dwarvish Guardsman
        [/allow_recruit]
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Hey, did you hear something?")}
        {MSG (
            side=2
            x,y=18,13
        ) (_ "What did it sound like?")}
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Like a fire burning.")}
        {MSG (
            side=2
            x,y=18,13
        ) (_ "You idiot, you are working in a forge, what do you expect to hear?")}
        {MSG (
            side=2
            x,y=18,11
        ) (_ "Oh nevermind.")}
    [/event]

    {ON_ATTACK_MESSAGE fire_attack_msg (
        id=fireleader
    ) (
        side=2
    ) (
        {ID_MESSAGE $unit2_id (_ "What on Irdya is this thing, has the lava come to life?!
Get this thing off of my back!")}
        {MSG (
            side=2
            [not]
                id=$unit2_id
            [/not]
        ) (_ "Hold on, I'm coming!")}
    )}

    {ON_ATTACK_MESSAGE rock_attack_msg (
        id=rockleader
    ) (
        side=3
    ) (
        {ID_MESSAGE $unit2_id (_ "Hey, these boulders are moving, I think it is some kind of golem.")}
        {MSG (
            side=3
            type=Dwarvish Thunderguard
        ) (_ "What? I'll send some backup your way just in case.")}
    )}

    [event]
        name=post advance
        [filter]
            id=fireleader
        [/filter]
        {ID_MESSAGE fireleader (_ "Ah, my strength is returning, but I am not whole. I must find a way to reunite myself.")}
        {NARRATOR (_ "As your power grows, you begin to remember that the dwarves are partly responsible for you captivity.

A thought also begins to form in your mind about a potential way to unite the separate parts of yourself back together.")}

        [fire_event]
            name=check fire victory
        [/fire_event]
    [/event]

    [event]
        name=post advance
        first_time_only=no
        [filter]
            id=fireleader
        [/filter]
        {VARIABLE_OP fire_advancement_counter add 1}
        [if]
            [have_unit]
                side=1
                count=1-4
            [/have_unit]
            [then]
                {ID_MESSAGE fireleader (_ "Ah, I can feel my magic power growing. Rise creature of the flame!")}
                {FIND_NEARBY (
                    terrain=Qlf,Ql
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                ) $unit.x $unit.y 10}
                {SCROLL_TO $nearby_locations[0].x $nearby_locations[0].y}
                {GENERIC_UNIT 1 ("Fire Wisp") $nearby_locations[0].x $nearby_locations[0].y}
                [+unit]
                    animate=yes
                [/unit]
                {REDRAW_MACRO}
                {MSG (
                    x,y=$nearby_locations[0].x,$nearby_locations[0].y
                ) (_ "I live to serve.")}
                {CLEANUP_SEARCH}
            [/then]
        [/if]
        [if]
            [variable]
                name=fire_advancement_counter
                equals=2
            [/variable]
            [then]
                {ID_MESSAGE fireleader (_ "I can feel the lava, I can control it! Let their roads burn!")}
                [terrain]
                    x,y=14,7
                    terrain=Ql
                [/terrain]
                {VARIABLE tmp_y 8}
                [store_locations]
                    terrain=Ur
                    variable=tmp_locs
                [/store_locations]
                {DEBUG "Num roads: $tmp_locs.length"}
                {VARIABLE show_kill_message yes}
                [while]
                    [variable]
                        name=tmp_y
                        less_than=20
                    [/variable]
                    [do]
                        {DEBUG "y: $tmp_y"}
                        {FOREACH tmp_locs i}
                            {IF_VAR tmp_y equals $tmp_locs[$i].y (
                                [then]
                                    {DEBUG "x,y: $tmp_locs[$i].x,$tmp_locs[$i].y"}
                                    [terrain]
                                        x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        terrain=Qlf
                                    [/terrain]
                                    {REDRAW_MACRO}
                                    [if]
                                        [have_unit]
                                            [not]
                                                side=1
                                            [/not]
                                            x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        [/have_unit]
                                        [variable]
                                            name=show_kill_message
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE show_kill_message no}
                                            {MSG (
                                                x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                            ) (_ "Arrrrghhh, the roads are melting!")}
                                        [/then]
                                    [/if]
                                    [kill]
                                        [not]
                                            side=1
                                        [/not]
                                        x,y=$tmp_locs[$i].x,$tmp_locs[$i].y
                                        fire_event=yes
                                        animate=yes
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}
                        [delay]
                            time=250
                        [/delay]
                        {VARIABLE_OP tmp_y add 1}
                    [/do]
                [/while]
                {IF_VAR show_kill_message equals yes (
                    [then]
                        {VARIABLE show_kill_message no}
                        {MSG (
                            side=2
                        ) (_ "The roads have melted!")}
                    [/then]
                )}
                {CLEAR_VARIABLE tmp_locs}
                {CLEAR_VARIABLE tmp_y}
                {CLEAR_VARIABLE show_kill_message}
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
            canrecruit=yes
        [/filter]
        [fire_event]
            name=check fire victory
        [/fire_event]
    [/event]
    [event]
        name=check fire victory
        first_time_only=no
        {STORE_UNIT_VAR (id=fireleader) level fire_level}
        [if]
            [variable]
                name=fire_level
                equals=2
            [/variable]
            [have_unit]
                side=2
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                [unit]
                    side=1
                    id=rockleader
                    type=Rock Pile
                    x,y=1,47
                    canrecruit=yes
                    {IS_HERO}
                    [modifications]
                        {TRAIT_HEALTHY}
                        {TRAIT_STRONG}
                    [/modifications]
                [/unit]
                [store_unit]
                    [filter]
                        side=1
                        [not]
                            id=rockleader
                        [/not]
                    [/filter]
                    variable=fire_units
                    kill=yes
                    fire_event=no
                [/store_unit]
                {REDRAW_MACRO}
                {NARRATOR (_ "Meanwhile...")}
                {SCROLL_TO 1 47}
                {ID_MESSAGE rockleader (_ "I hear hammers hitting wall.")}
                {MOVE_UNIT id=rockleader 4 47}
                {ID_MESSAGE rockleader (_ "Wall is thin, see who invades caves...")}
                {REPEAT 4 (
                    [animate_unit]
                        flag=attack
                        [filter]
                            id=rockleader
                        [/filter]
                        [primary_attack]
                            range=melee
                        [/primary_attack]
                        hits=yes
                        [facing]
                            x,y=5,47
                        [/facing]
                    [/animate_unit]
                    {QUAKE "rumble.ogg"}
                )}
                {MODIFY_TERRAIN Uh (5) (47-48)}
                {REDRAW_MACRO}
                [modify_side]
                    side=3
                    switch_ai=ai/ais/default_ai.cfg
                [/modify_side]
                [modify_side]
                    side=3
                    [ai]
                        leader_aggression=0.0
                    [/ai]
                [/modify_side]
                [allow_recruit]
                    side=3
                    type=Dwarvish Fighter,Dwarvish Thunderer
                [/allow_recruit]

                {MSG (
                    x,y=8,45
                ) (_ "What is going on, are you using powder to blast those walls?!")}
                {MSG (
                    x,y=6,47
                ) (_ "No the wall just shuck violently and came crashing down. I don't see anything though except for a bunch of boulders. I'll have a look.")}

                [modify_turns]
                    add=36
                [/modify_turns]
                {VARIABLE turns_limited yes}

                # Reminder:
                [show_objectives]
                    side=1
                [/show_objectives]
            [/then]
        [/if]
        {CLEAR_VARIABLE fire_level}
    [/event]

    [event]
        name=post advance
        first_time_only=no
        [filter]
            id=rockleader
        [/filter]
        {ID_MESSAGE rockleader (_ "Rise my rocks and kill the invaders!")}
        {FIND_NEARBY (
            terrain=Uh
            [not]
                [filter]
                [/filter]
            [/not]
        ) $x1 $y1 10}
        {GENERIC_UNIT 1 "Rock Pile" $nearby_locations[0].x $nearby_locations[0].y}
        [+unit]
            animate=yes
        [/unit]
        {CLEANUP_SEARCH}
    [/event]

    [event]
        name=post advance
        [filter]
            id=rockleader
        [/filter]
        {ID_MESSAGE rockleader (_ "Much stronger now, head starting to clear. Hmmmm, lets see what I can do with that dwarven encampment...")}

        [remove_shroud]
            side=1
            x=8-12
            y=41-45
        [/remove_shroud]
        {SCROLL_TO 10 42}
        {QUAKE "rumble.ogg"}
        {MODIFY_TERRAIN Uu^Dr (9,10-11) (42-43,42)}
        {REDRAW_MACRO}
        {MSG (
            side=3
            canrecruit=yes
        ) (_ "Our keep has been destroyed!")}
        [fire_event]
            name=check rock victory
        [/fire_event]
    [/event]

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        {DEBUG "Side 3 leader died"}
        [fire_event]
            name=check rock victory
        [/fire_event]
    [/event]

    [event]
        name=check rock victory
        first_time_only=no
        {DEBUG "Checking rock victory..."}
        {STORE_UNIT_VAR (id=rockleader) level rock_level}
        [if]
            [variable]
                name=rock_level
                greater_than_equal_to=2
            [/variable]
            [have_unit]
                side=3
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                [unit]
                    side=1
                    id=airleader
                    type=Whirlwind
                    x,y=50,50
                    canrecruit=yes
                    {IS_HERO}
                    [modifications]
                        {TRAIT_DEXTROUS}
                        {TRAIT_RESILIENT}
                    [/modifications]
                [/unit]
                [store_unit]
                    [filter]
                        side=1
                        [not]
                            id=airleader
                        [/not]
                    [/filter]
                    variable=rock_units
                    kill=yes
                    fire_event=no
                [/store_unit]
                {REDRAW_MACRO}
                {NARRATOR (_ "During this time, the whirlwind was investigating the open cavernous areas...")}
                {SCROLL_TO 50 50}
                {ID_MESSAGE airleader (_ "More open caves. I must build my strength. Wait... I hear the sound of tools being used on rocks echoing in these caverns. I must find the source.")}
                [modify_turns]
                    add=36
                [/modify_turns]
                [modify_side]
                    side=4
                    switch_ai=ai/ais/default_ai.cfg
                [/modify_side]
                [allow_recruit]
                    side=4
                    type=Dwarvish Fighter
                [/allow_recruit]

                {VARIABLE kill_leader_objectives no}
                {VARIABLE turns_limited yes}
                [show_objectives]
                    side=1
                [/show_objectives]
            [/then]
        [/if]
        {CLEAR_VARIABLE rock_level}
    [/event]

    [event]
        name=sighted
        [filter]
            side=4
        [/filter]
        [filter_second]
            id=airleader
        [/filter_second]
        {MSG (
            side=4
            [not]
                canrecruit=yes
            [/not]
        ) (_ "Hey, is it getting windy or what?")}
        {MSG (
            side=4
            canrecruit=yes
        ) (_ "Cut the chatter and get back to building that bridge!")}
    [/event]
    {ON_ATTACK_MESSAGE air_attack_msg (
        id=airleader
    ) (
        side=4
    ) (
        {ID_MESSAGE $unit2_id (_ "This wind is no ordinary force of nature. I think it is some kind of monster. To arms!")}

        {VARIABLE kill_leader_objectives yes}
        [show_objectives]
            side=1
        [/show_objectives]
    )}

    [event]
        name=post advance
        [filter]
            id=airleader
        [/filter]
        {ID_MESSAGE airleader (_ "Ah, my strength is returning. Now to whip up the air in here a bit...")}
        {REPEAT 3 (
            {FIND_NEARBY (
                terrain=Qxu
                [not]
                    [filter]
                    [/filter]
                [/not]
            ) $x1 $y1 10}
            {GENERIC_UNIT 1 Whirlwind $nearby_locations[0].x $nearby_locations[0].y}
            [+unit]
                animate=yes
            [/unit]
            {CLEANUP_SEARCH}
        )}
        {MSG (
            side=1
            type=Whirlwind
        ) (_ "Command us master.")}
        {ID_MESSAGE airleader (_ "Kill the dwarves")}
        {MSG (
            side=1
            type=Whirlwind
        ) (_ "As you command.")}
        [fire_event]
            name=check air victory
        [/fire_event]
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [fire_event]
            name=check air victory
        [/fire_event]
    [/event]

    [event]
        name=check air victory
        first_time_only=no
        {STORE_UNIT_VAR (id=airleader) level air_level}
        [if]
            [variable]
                name=air_level
                greater_than_equal_to=2
            [/variable]
            [have_unit]
                side=4
                canrecruit=yes
                count=0
            [/have_unit]
            [then]
                # TODO: conclude scenario story

                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/then]
        [/if]
        {CLEAR_VARIABLE air_level}
    [/event]

    #TODO: last breath events

    # Test events:
    [event]
        #Use: lua wesnoth.fire_event("advanceleader")
        name=advanceleader
        first_time_only=no
        {ADVANCE_UNIT canrecruit,side=yes,1 ""}
    [/event]
[/scenario]
